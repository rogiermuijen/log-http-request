

function toggleCaptureButton() {
    captureTraffic == 1 ? 
        $("#capture").parent().addClass("active") :
        $("#capture").parent().removeClass("active");
    showInfo(selectedInfo)
}

function capture(n) {
    switch (n) {
        case "main_frame": return settings.cap_MainFrame;
        case "sub_frame": return settings.cap_SubFrame;
        case "stylesheet": return settings.cap_Stylesheet;
        case "script": return settings.cap_Script;
        case "image": return settings.cap_Image;
        case "object": return settings.cap_Object;
        case "xmlhttprequest": return settings.cap_Xmlhttprequest;
        case "other": return settings.cap_other
    } return 0
}

function resetAll() {
    selectedInfo = 0;
    headerInfo = {};
    headerInfo.response = [];
    headerInfo.request = [];
    $("#result").empty();
    $("#responseList > tbody").empty();
    $("#previewArea").empty().html(defaultText)
}

function resizeWindow() {
    $(".results").css("height", "0px");
    $(".preview").css("width", "0px");
    $("#mainTable").height($(window).height() - $(".nav-pills").height());
    $(".results").css("height", $("#mainTable td").css("height"));
    $(".preview").css("width", $("#previewArea").css("width"));
    $(".codeBlock").height($("#previewArea").height());
    $(".codeBlock").width($("#previewArea").width())
}

function showHeader(n) {
    var i = n - 1,
        url = headerInfo.response[i].url,
        status = headerInfo.response[i].statusLine.split(" "),
        txt = "";

    txt += "<tr>";
    txt += '<td class="rId">' + (i + 1) + "<\/td>";
    txt += '<td class="rMe">' + headerInfo.response[i].type + "<\/td>";
    txt += '<td><input type="text" class="inputUrl" value="' + url + '" /><\/td>';
    txt += "<\/tr>";
    settings.list_Ascending == 1 ? (headerInfo.response.length >= 500 && $("#responseList > tbody tr").first().remove(),
                                        $("#responseList > tbody:last").append(txt))
                                  : (headerInfo.response.length >= 500 && $("#responseList > tbody tr").last().remove(),
                                        $("#responseList > tbody:first").prepend(txt))
}

function showInfo(n) {
    n != 0 && (settings.view_Raw == 1 ? showRawInfo(n) : showNiceInfo(n))
}

function showNiceInfo(n) {
    var i = n - 1, t, r, e, f, u;

    t = '<div class="results preview" style="overflow: auto;">',
    t += '<table class="table table-bordered table-condensed table-hover">',
    t += '<tr class="' + getClassStyle(headerInfo.response[i].statusLine) + '"><td colspan="2">',
    t += "<b>Request URL: <\/b>" + headerInfo.response[i].url + "<br />",
    t += "<\/td><\/tr>",
    t += '<tr class="warning"><td colspan="2"><b>Referer URL: <\/b>';

    for (r = 0, e = headerInfo.request[i].requestHeaders.length; r < e; ++r) {
        f = headerInfo.request[i].requestHeaders[r].name;
        u = headerInfo.request[i].requestHeaders[r].value;
        if (f.toLowerCase() == 'referer')
            t += u + '<\/td><\/tr>';
    }
    $("#previewArea").empty().html(t);
    resizeWindow()
}

var headerInfo = {}, settings = {}, tabId = "", selectedInfo = 0, captureTraffic = 1, defaultText = "";

settings.view_Raw = 0;
settings.cap_MainFrame = 1;
settings.cap_SubFrame = 1;
settings.cap_Stylesheet = 1;
settings.cap_Script = 1;
settings.cap_Image = 1;
settings.cap_Object = 1;
settings.cap_Xmlhttprequest = 1;
settings.cap_other = 1;
settings.list_Ascending = 0;

$(function () {
    headerInfo.response = [];
    headerInfo.request = [];
    defaultText = $("#previewArea").html();
    chrome.webRequest.onHeadersReceived.addListener(
        function (n) {
            capture(n.type) == 1 && captureTraffic == 1 && (headerInfo.response.push(n), showHeader(headerInfo.response.length))
        },
        {
            urls: ["<all_urls>"],
            types: ["main_frame", "sub_frame", "stylesheet", "script", "image", "object", "xmlhttprequest", "other"]
        },
        ["blocking", "responseHeaders"]);
    chrome.webRequest.onSendHeaders.addListener(
        function (n) {
            capture(n.type) == 1 && captureTraffic == 1 && headerInfo.request.push(n)
        },
        {
            urls: ["<all_urls>"],
            types: ["main_frame", "sub_frame", "stylesheet", "script", "image", "object", "xmlhttprequest", "other"]
        },
        ["requestHeaders"]);

    $("#responseList").click(
        function (e) {
            if (e.toElement.nodeName.toLowerCase() == "td" ||
                e.toElement.nodeName.toLowerCase() == "input" ||
                e.toElement.nodeName.toLowerCase() == "span")
            {
                var t = $(e.toElement).closest("tr").children().first("td").html();
                $(e.toElement).closest("tr").children("td").children("input").select();
                selectedInfo = t;
                showInfo(t)
            }
        });
    $("#clearAll").click(
        function () {
            resetAll()
        });
    $("#capture").click(function () {
        captureTraffic = captureTraffic == 0; showInfo(selectedInfo); toggleCaptureButton()
    });

    settings.cap_MainFrame = 1,
    settings.cap_SubFrame = 1,
    settings.cap_Stylesheet = 1,
    settings.cap_Script = 1,
    settings.cap_Image = 1,
    settings.cap_Object = 1,
    settings.cap_Xmlhttprequest = 1,
    settings.cap_other = 1,
    settings.view_Raw = 0,
    settings.list_Ascending = 0,
    chrome.tabs.getCurrent(function (n) {

        chrome.extension.getBackgroundPage().viewTabId = n.id;
    });
    resizeWindow();
});

$(window).resize(function () { resizeWindow() });

